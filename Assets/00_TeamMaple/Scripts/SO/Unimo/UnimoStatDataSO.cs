using System.Collections.Generic;
using System.Globalization;
using UnityEngine;
using System.IO;
using CsvHelper;

public enum UnimoRank
{
    N,
    P
}

public enum UnimoStat
{
    None,
    All,
    Hp,
    Def,
    Speed,
    BloomRange,
    BloomSpeed,
    FlowerRate,
    RareFlowerRate,
    Dodge,
    StunRecovery,
    HpRecovery,
    FlowerDropSpeed,
    FlowerDropAmount
}

[System.Serializable]
public class UnimoStatData
{
    public int Id { get; set; }    // 유니모 아이디
    public int Level { get; set; }    // 유니모 레벨
    public string Name { get; set; }    // 유니모 이름
    public UnimoRank Rank { get; set; }    // 유니모 등급
    public UnimoStat SpecialStat1 { get; set; }    // 유니모 특화 스탯 1
    public UnimoStat SpecialStat2 { get; set; }    // 유니모 특화 스탯 2
    public UnimoStat SpecialStat3 { get; set; }    // 유니모 특화 스탯 3
    public int Hp { get; set; }    // 유니모 체력
    public int Def { get; set; }    // 유니모 방어력
    public float Speed { get; set; }    // 유니모 속도
    public int BloomRange { get; set; }    // 개화 범위
    public float BloomSpeed { get; set; }    // 개화 속도
    public float FlowerRate { get; set; }    // 꽃 생성 주기
    public float RareFlowerRate { get; set; }    // 희귀 꽃 생성 주기 
    public float Dodge { get; set; }    // 회피율
    public float StunRecovery { get; set; }    // 스턴 회복력
    public float HpRecovery { get; set; }    // 체력 회복력
    public float FlowerDropSpeed { get; set; }    // 꽃 낙하 속도
    public float FlowerDropAmount { get; set; }    // 꽃 낙하량
    
    // 회피율 계산 
    public bool DodgeCalculation(float dodge)
    {
        float evadeRate =  dodge * 100f;
        int rand = Random.Range(0, 100);

        if (rand < evadeRate)
        {
            return false;
        }
        else
        {
            return true;
        }
    }
    
    // 스턴 지속시간 계산
    public float stunDuration(float recovery)
    {
        float stunRecovery =   recovery * 100f;
        return 1- stunRecovery;
    }
}

[CreateAssetMenu(fileName = "UnimoStatDataSO", menuName = "Scriptable Object/UnimoStatDataSO")]
public class UnimoStatDataSO : ScriptableObject
{
    [Header("UnimoStatDataCsv")]
    [SerializeField] private TextAsset unimoStatDataCsv;

    /// <summary>
    /// 입력 받은 아이디에 따라 데이터 반환
    /// </summary>
    public UnimoStatData GetUnimoStatData(int unimoID)
    {
        if (unimoStatDataCsv == null)
        {
            Debug.LogError("UnimoStatDataCsv is null");
            return null;
        }

        using (StringReader reader = new StringReader(unimoStatDataCsv.text))
        using (CsvReader csv = new CsvReader(reader, CultureInfo.InvariantCulture))
        {
            csv.Read(); // unimo_id, name, hp, ...
            csv.ReadHeader();   // 헤더 등록
            
            IEnumerable<UnimoStatData> records = csv.GetRecords<UnimoStatData>();

            foreach (UnimoStatData record in records)
            {
                if (record.Id == unimoID)
                    return record;
            }
        }

        Debug.LogWarning($"UnimoStatData with ID {unimoID} not found.");
        return null;
    }
    
    /// <summary>
    /// 임시 초기 유니모 데이터 생성
    /// </summary>
    public UnimoStatData CreateDefaultUnimo()
    {
        return new UnimoStatData
        {
            Id = 0,
            Level = 1,
            Name = "Unimo",

            Rank = UnimoRank.N,

            SpecialStat1 = UnimoStat.None,
            SpecialStat2 = UnimoStat.None,
            SpecialStat3 = UnimoStat.None,

            Hp = 100,
            Def = 10,
            Speed = 1,

            BloomRange = 1,
            BloomSpeed = 1.0f,
            FlowerRate = 5.0f,
            RareFlowerRate = 20.0f,

            Dodge = 0.3f,
            StunRecovery = 1.0f,
            HpRecovery = 0.5f,
            FlowerDropSpeed = 1.0f,
            FlowerDropAmount = 1.0f
        };
    }

    /// <summary>
    /// 임시 유니모 데이터 셋팅
    /// </summary>
    public UnimoData SettingsUnimoData(int Id)
    {
        Debug.Log(GetUnimoData(Id));
        
        return GetUnimoData(Id);
    }
}